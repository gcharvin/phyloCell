<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of phy_icp</title>
  <meta name="keywords" content="phy_icp">
  <meta name="description" content="ICP Iterative Closest Point Algorithm. Takes use of">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2003 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../m2html.css">
</head>
<body>
<a name="_top"></a>
<!-- # phyloCell -->
<h1>phy_icp
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>ICP Iterative Closest Point Algorithm. Takes use of</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>function [TR, TT, iclosest,distance,ERROR] = phy_icp(model,data,max_iter,min_iter,fitting,thres,init_flag,tes_flag,refpnt) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre class="comment"> ICP Iterative Closest Point Algorithm. Takes use of
 Delaunay tesselation of points in model.
   
   iclosest = indices of closest MODEL points
   distance = the distances to the closests Model points
   ERROR = total error 
   
   Ordinary usage:

   [R, T] = icp(model,data)

   ICP fit points in data to the points in model.
   Fit with respect to minimize the sum of square
   errors with the closest model points and data points.

   INPUT:

   model - matrix with model points, [Pm_1 Pm_2 ... Pm_nmod]
   data - matrix with data points,   [Pd_1 Pd_2 ... Pd_ndat]

   OUTPUT:

   R - rotation matrix and
   T - translation vector accordingly so

           newdata = R*data + T .

   newdata are transformed data points to fit model


   Special usage:

   icp(model)  or icp(model,tes_flag)

   ICP creates a Delaunay tessellation of points in
   model and save it as global variable Tes. ICP also
   saves two global variables ir and jc for tes_flag=1 (default) or
   Tesind and Tesver for tes_flag=2, which
   makes it easy to find in the tesselation. To use the global variables
   in icp, put tes_flag to 0.


   Other usage:

   [R, T] = icp(model,data,max_iter,min_iter,...
                         fitting,thres,init_flag,tes_flag)

   INPUT:

     max_iter - maximum number of iterations. Default=104

     min_iter - minimum number of iterations. Default=4

   fitting  -  =2 Fit with respect to minimize the sum of square errors. (default)
                  alt. =[2,w], where w is a weight vector corresponding to data.
                  w is a vector of same length as data.
                  Fit with respect to minimize the weighted sum of square errors.
               =3 Fit with respect to minimize the sum to the amount 0.95
                  of the closest square errors.
                  alt. =[3,lambda], 0.0&lt;lambda&lt;=1.0, (lambda=0.95 default)
                  In each iteration only the amount lambda of the closest
                  points will affect the translation and rotation.
                  If 1&lt;lambda&lt;=size(data,2), lambda integer, only the number lambda
                  of the closest points will affect the translation and
                  rotation in each iteration.

     thres - error differens threshold for stop iterations. Default 1e-5

     init_flag  -  =0 no initial starting transformation
                 =1 transform data so the mean value of
                     data is equal to mean value of model.
                     No rotation. (init_flag=1 default)

     tes_flag  -  =0 No new tesselation has to be done. There
                   alredy exists one for the current model points.
                =1 A new tesselation of the model points will
                   be done. (default)
                =2 A new tesselation of the model points will
                   be done. Another search strategy than tes_flag=1
                =3 The closest point will be find by testing
                   all combinations. No Delaunay tesselation will be done.

   refpnt - (optional) (An empty vector is default.) refpnt is a point corresponding to the
                 set of model points wich correspondig data point has to be find.
                 How the points are weighted depends on the output from the
                 function weightfcn found in the end of this m-file. The input in weightfcn is the
                 distance between the closest model point and refpnt.

   To clear old global tesselation variables run: &quot;clear global Tes ir jc&quot; (tes_flag=1)
   or run: &quot;clear global Tes Tesind Tesver&quot; (tes_flag=2) in Command Window.

   m-file can be downloaded for free at
   http://www.mathworks.com/matlabcentral/fileexchange/loadFile.do?objectId=12627&amp;objectType=FILE

   icp version 1.4

   written by Per Bergstr�m 2007-03-07</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../matlabicon.gif)">
</ul>
This function is called by:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="phy_mapObjects.html" class="code" title="function objectOut=phy_mapObjects(distanceParameter,objecti,objecti_1,objecti_2)">phy_mapObjects</a>	mapping objects</li></ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="#_sub1" class="code">function icp_init(init_flag,fitting)</a></li><li><a href="#_sub2" class="code">function tes_flag=icp_struct(tes_flag)</a></li><li><a href="#_sub3" class="code">function ERROR=icp_closest_start(tes_flag,fitting)</a></li><li><a href="#_sub4" class="code">function ERROR=icp_closest(tes_flag,fitting)</a></li><li><a href="#_sub5" class="code">function ind=icp_transformation(fitting,refpnt)</a></li><li><a href="#_sub6" class="code">function ERR=err(dist,fitting,ind)</a></li><li><a href="#_sub7" class="code">function weights=weightfcn(distances)</a></li></ul>
<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function [TR, TT, iclosest,distance,ERROR] = phy_icp(model,data,max_iter,min_iter,fitting,thres,init_flag,tes_flag,refpnt)</a>
0002 <span class="comment">% ICP Iterative Closest Point Algorithm. Takes use of</span>
0003 <span class="comment">% Delaunay tesselation of points in model.</span>
0004 <span class="comment">%</span>
0005 <span class="comment">%   iclosest = indices of closest MODEL points</span>
0006 <span class="comment">%   distance = the distances to the closests Model points</span>
0007 <span class="comment">%   ERROR = total error</span>
0008 <span class="comment">%</span>
0009 <span class="comment">%   Ordinary usage:</span>
0010 <span class="comment">%</span>
0011 <span class="comment">%   [R, T] = icp(model,data)</span>
0012 <span class="comment">%</span>
0013 <span class="comment">%   ICP fit points in data to the points in model.</span>
0014 <span class="comment">%   Fit with respect to minimize the sum of square</span>
0015 <span class="comment">%   errors with the closest model points and data points.</span>
0016 <span class="comment">%</span>
0017 <span class="comment">%   INPUT:</span>
0018 <span class="comment">%</span>
0019 <span class="comment">%   model - matrix with model points, [Pm_1 Pm_2 ... Pm_nmod]</span>
0020 <span class="comment">%   data - matrix with data points,   [Pd_1 Pd_2 ... Pd_ndat]</span>
0021 <span class="comment">%</span>
0022 <span class="comment">%   OUTPUT:</span>
0023 <span class="comment">%</span>
0024 <span class="comment">%   R - rotation matrix and</span>
0025 <span class="comment">%   T - translation vector accordingly so</span>
0026 <span class="comment">%</span>
0027 <span class="comment">%           newdata = R*data + T .</span>
0028 <span class="comment">%</span>
0029 <span class="comment">%   newdata are transformed data points to fit model</span>
0030 <span class="comment">%</span>
0031 <span class="comment">%</span>
0032 <span class="comment">%   Special usage:</span>
0033 <span class="comment">%</span>
0034 <span class="comment">%   icp(model)  or icp(model,tes_flag)</span>
0035 <span class="comment">%</span>
0036 <span class="comment">%   ICP creates a Delaunay tessellation of points in</span>
0037 <span class="comment">%   model and save it as global variable Tes. ICP also</span>
0038 <span class="comment">%   saves two global variables ir and jc for tes_flag=1 (default) or</span>
0039 <span class="comment">%   Tesind and Tesver for tes_flag=2, which</span>
0040 <span class="comment">%   makes it easy to find in the tesselation. To use the global variables</span>
0041 <span class="comment">%   in icp, put tes_flag to 0.</span>
0042 <span class="comment">%</span>
0043 <span class="comment">%</span>
0044 <span class="comment">%   Other usage:</span>
0045 <span class="comment">%</span>
0046 <span class="comment">%   [R, T] = icp(model,data,max_iter,min_iter,...</span>
0047 <span class="comment">%                         fitting,thres,init_flag,tes_flag)</span>
0048 <span class="comment">%</span>
0049 <span class="comment">%   INPUT:</span>
0050 <span class="comment">%</span>
0051 <span class="comment">%     max_iter - maximum number of iterations. Default=104</span>
0052 <span class="comment">%</span>
0053 <span class="comment">%     min_iter - minimum number of iterations. Default=4</span>
0054 <span class="comment">%</span>
0055 <span class="comment">%   fitting  -  =2 Fit with respect to minimize the sum of square errors. (default)</span>
0056 <span class="comment">%                  alt. =[2,w], where w is a weight vector corresponding to data.</span>
0057 <span class="comment">%                  w is a vector of same length as data.</span>
0058 <span class="comment">%                  Fit with respect to minimize the weighted sum of square errors.</span>
0059 <span class="comment">%               =3 Fit with respect to minimize the sum to the amount 0.95</span>
0060 <span class="comment">%                  of the closest square errors.</span>
0061 <span class="comment">%                  alt. =[3,lambda], 0.0&lt;lambda&lt;=1.0, (lambda=0.95 default)</span>
0062 <span class="comment">%                  In each iteration only the amount lambda of the closest</span>
0063 <span class="comment">%                  points will affect the translation and rotation.</span>
0064 <span class="comment">%                  If 1&lt;lambda&lt;=size(data,2), lambda integer, only the number lambda</span>
0065 <span class="comment">%                  of the closest points will affect the translation and</span>
0066 <span class="comment">%                  rotation in each iteration.</span>
0067 <span class="comment">%</span>
0068 <span class="comment">%     thres - error differens threshold for stop iterations. Default 1e-5</span>
0069 <span class="comment">%</span>
0070 <span class="comment">%     init_flag  -  =0 no initial starting transformation</span>
0071 <span class="comment">%                 =1 transform data so the mean value of</span>
0072 <span class="comment">%                     data is equal to mean value of model.</span>
0073 <span class="comment">%                     No rotation. (init_flag=1 default)</span>
0074 <span class="comment">%</span>
0075 <span class="comment">%     tes_flag  -  =0 No new tesselation has to be done. There</span>
0076 <span class="comment">%                   alredy exists one for the current model points.</span>
0077 <span class="comment">%                =1 A new tesselation of the model points will</span>
0078 <span class="comment">%                   be done. (default)</span>
0079 <span class="comment">%                =2 A new tesselation of the model points will</span>
0080 <span class="comment">%                   be done. Another search strategy than tes_flag=1</span>
0081 <span class="comment">%                =3 The closest point will be find by testing</span>
0082 <span class="comment">%                   all combinations. No Delaunay tesselation will be done.</span>
0083 <span class="comment">%</span>
0084 <span class="comment">%   refpnt - (optional) (An empty vector is default.) refpnt is a point corresponding to the</span>
0085 <span class="comment">%                 set of model points wich correspondig data point has to be find.</span>
0086 <span class="comment">%                 How the points are weighted depends on the output from the</span>
0087 <span class="comment">%                 function weightfcn found in the end of this m-file. The input in weightfcn is the</span>
0088 <span class="comment">%                 distance between the closest model point and refpnt.</span>
0089 <span class="comment">%</span>
0090 <span class="comment">%   To clear old global tesselation variables run: &quot;clear global Tes ir jc&quot; (tes_flag=1)</span>
0091 <span class="comment">%   or run: &quot;clear global Tes Tesind Tesver&quot; (tes_flag=2) in Command Window.</span>
0092 <span class="comment">%</span>
0093 <span class="comment">%   m-file can be downloaded for free at</span>
0094 <span class="comment">%   http://www.mathworks.com/matlabcentral/fileexchange/loadFile.do?objectId=12627&amp;objectType=FILE</span>
0095 <span class="comment">%</span>
0096 <span class="comment">%   icp version 1.4</span>
0097 <span class="comment">%</span>
0098 <span class="comment">%   written by Per Bergstr�m 2007-03-07</span>
0099 
0100 
0101 <span class="keyword">if</span> nargin&lt;1
0102 
0103     error(<span class="string">'To few input arguments!'</span>);
0104 
0105 <span class="keyword">elseif</span> or(nargin==1,nargin==2)
0106 
0107     bol=1;
0108     refpnt=[];
0109     <span class="keyword">if</span> nargin==2
0110         <span class="keyword">if</span> isempty(data)
0111             tes_flag=1;
0112         <span class="keyword">elseif</span> isscalar(data)
0113             tes_flag=data;
0114             <span class="keyword">if</span> not(tes_flag==1 | tes_flag==2)
0115                 tes_flag=1;
0116             <span class="keyword">end</span>
0117         <span class="keyword">else</span>
0118             bol=0;
0119         <span class="keyword">end</span>
0120     <span class="keyword">else</span>
0121         tes_flag=1;
0122     <span class="keyword">end</span>
0123 
0124     <span class="keyword">if</span> bol
0125 
0126         <span class="keyword">global</span> MODEL
0127 
0128         <span class="keyword">if</span> isempty(model)
0129             error(<span class="string">'Model can not be an empty matrix.'</span>);
0130         <span class="keyword">end</span>
0131 
0132         <span class="keyword">if</span> (size(model,2)&lt;size(model,1))
0133             MODEL=model';
0134             TR=eye(size(model,2));
0135             TT=zeros(size(model,2),1);
0136         <span class="keyword">else</span>
0137             MODEL=model;
0138             TR=eye(size(model,1));
0139             TT=zeros(size(model,1),1);
0140         <span class="keyword">end</span>
0141 
0142         <span class="keyword">if</span> (size(MODEL,2)==size(MODEL,1))
0143             <span class="comment">%error('This icp method demands the number of MODEL points to be greater then the dimension.');</span>
0144             <span class="comment">%comented by andrei</span>
0145             warning(<span class="string">'This icp method demands the number of model points to be greater then the dimension.'</span>);<span class="comment">%added by andrei</span>
0146             tes_flag=3;<span class="comment">%added by andrei</span>
0147         <span class="keyword">end</span>
0148 
0149         <a href="#_sub2" class="code" title="subfunction tes_flag=icp_struct(tes_flag)">icp_struct</a>(tes_flag);
0150 
0151         <span class="keyword">return</span>
0152     <span class="keyword">end</span>
0153 <span class="keyword">end</span>
0154 
0155 <span class="keyword">global</span> MODEL DATA TR TT iclosest ERROR distance <span class="comment">%iclosest, ERROR distance added by andrei</span>
0156 distance=[];
0157 ERROR=0;
0158 iclosest=[];
0159 TT=[];
0160 TR=[];
0161 DATA=[];
0162 Model=[];
0163 
0164 <span class="keyword">if</span> isempty(model)
0165     <span class="comment">%error('Model can not be an empty matrix.');</span>
0166     <span class="comment">%comented by andrei</span>
0167     warning(<span class="string">'Model can not be an empty matrix.'</span>); <span class="comment">% added by andrei</span>
0168     <span class="keyword">return</span>      <span class="comment">%added by andrei</span>
0169 <span class="keyword">end</span>
0170 
0171 <span class="keyword">if</span> (size(model,2)&lt;size(model,1)) &amp;&amp; (min(size(model))&gt;1) <span class="comment">% &amp;&amp; added by andrei</span>
0172     MODEL=model';
0173 <span class="keyword">else</span>
0174     MODEL=model;
0175 <span class="keyword">end</span>
0176 
0177 <span class="keyword">if</span> (size(data,2)&lt;size(data,1)) &amp;&amp; (min(size(data))&gt;1) <span class="comment">% &amp;&amp; added by andrei</span>
0178     data=data';
0179     DATA=data;
0180 <span class="keyword">else</span>
0181     DATA=data;
0182 <span class="keyword">end</span>
0183 
0184 <span class="keyword">if</span> size(DATA,1)~=size(MODEL,1)
0185     <span class="comment">%error('Different dimensions of DATA and MODEL!');</span>
0186     <span class="comment">%comented by andrei</span>
0187     warning(<span class="string">'Different dimensions of DATA and MODEL!'</span>); <span class="comment">%added by andrei</span>
0188     <span class="keyword">return</span>      <span class="comment">%added by andrei</span>
0189 <span class="keyword">end</span>
0190 
0191 <span class="keyword">if</span> nargin&lt;9
0192     refpnt=[];
0193     <span class="keyword">if</span> nargin&lt;8
0194         tes_flag=1;
0195         <span class="keyword">if</span> nargin&lt;7
0196             init_flag=1;
0197             <span class="keyword">if</span> nargin&lt;6
0198                 thres=1e-5;                     <span class="comment">% threshold to icp iterations</span>
0199                 <span class="keyword">if</span> nargin&lt;5
0200                     fitting=2;                  <span class="comment">% fitting method</span>
0201                     <span class="keyword">if</span> nargin&lt;4
0202                         min_iter=4;             <span class="comment">% min number of icp iterations</span>
0203                         <span class="keyword">if</span> nargin&lt;3
0204                             max_iter=104;       <span class="comment">% max number of icp iterations</span>
0205                         <span class="keyword">end</span>
0206                     <span class="keyword">end</span>
0207                 <span class="keyword">end</span>
0208             <span class="keyword">end</span>
0209         <span class="keyword">end</span>
0210     <span class="keyword">end</span>
0211 <span class="keyword">elseif</span> nargin&gt;9
0212     warning(<span class="string">'Too many input arguments!'</span>);
0213 <span class="keyword">end</span>
0214 
0215 <span class="keyword">if</span> isempty(tes_flag)
0216     tes_flag=1;
0217 <span class="keyword">elseif</span> not(tes_flag==0 | tes_flag==1 | tes_flag==2 | tes_flag==3)
0218     init_flag=1;
0219     warning(<span class="string">'init_flag has been changed to 1'</span>);
0220 <span class="keyword">end</span>
0221 
0222 <span class="keyword">if</span> and((size(MODEL,2)&lt;=size(MODEL,1)),tes_flag~=0)
0223     <span class="comment">%error('This icp method demands the number of model points to be greater then the dimension.');</span>
0224      <span class="comment">%comented by andrei</span>
0225      warning(<span class="string">'This icp method demands the number of model points to be greater then the dimension.'</span>);<span class="comment">%added by andrei</span>
0226      tes_flag=3;<span class="comment">%added by andrei</span>
0227 <span class="keyword">end</span>
0228 
0229 <span class="keyword">if</span> isempty(min_iter)
0230     min_iter=4;
0231 <span class="keyword">end</span>
0232 
0233 <span class="keyword">if</span> isempty(max_iter)
0234     max_iter=100+min_iter;
0235 <span class="keyword">end</span>
0236 
0237 <span class="keyword">if</span> max_iter&lt;min_iter;
0238     max_iter=min_iter;
0239     warning(<span class="string">'max_iter&lt;min_iter , max_iter has been changed to be equal min_iter'</span>);
0240 <span class="keyword">end</span>
0241 
0242 <span class="keyword">if</span> min_iter&lt;0;
0243     min_iter=0;
0244     warning(<span class="string">'min_iter&lt;0 , min_iter has been changed to be equal 0'</span>);
0245 <span class="keyword">end</span>
0246 
0247 <span class="keyword">if</span> isempty(thres)
0248     thres=1e-5;
0249 <span class="keyword">elseif</span> thres&lt;0
0250     thres=abs(thres);
0251     warning(<span class="string">'thres negative , thres have been changed to -thres'</span>);
0252 <span class="keyword">end</span>
0253 
0254 <span class="keyword">if</span> isempty(fitting)
0255 
0256     fitting=2;
0257 
0258 <span class="keyword">elseif</span> fitting(1)==2
0259 
0260     [fi1,fi2]=size(fitting);
0261     lef=max([fi1,fi2]);
0262     <span class="keyword">if</span> lef&gt;1
0263         <span class="keyword">if</span> fi1&lt;fi2
0264             fitting=fitting';
0265         <span class="keyword">end</span>
0266 
0267         <span class="keyword">if</span> lef&lt;(size(data,2)+1)
0268             warning(<span class="string">'Illegeal size of fitting! Unweighted minimization will be used.'</span>);
0269             fitting=2;
0270         <span class="keyword">elseif</span> min(fitting(2:(size(data,2)+1)))&lt;0
0271             warning(<span class="string">'Illegeal value of the weights! Unweighted minimization will be used.'</span>);
0272             fitting=2;
0273         <span class="keyword">elseif</span> max(fitting(2:(size(data,2)+1)))==0
0274             warning(<span class="string">'Illegeal values of the weights! Unweighted minimization will be used.'</span>);
0275             fitting=2;
0276         <span class="keyword">else</span>
0277             su=sum(fitting(2:(size(data,2)+1)));
0278             fitting(2:(size(data,2)+1))=fitting(2:(size(data,2)+1))/su;
0279             thres=thres/su;
0280         <span class="keyword">end</span>
0281     <span class="keyword">end</span>
0282 
0283 <span class="keyword">elseif</span> fitting(1)==3
0284     <span class="keyword">if</span> length(fitting)&lt;2
0285         fitting=[fitting,round(0.95*size(data,2))];
0286     <span class="keyword">elseif</span> fitting(2)==1 <span class="comment">%added by andrei</span>
0287     <span class="keyword">elseif</span> fitting(2)&gt;1
0288 
0289         <span class="keyword">if</span> fitting(2)&gt;floor(fitting(2))
0290             fitting(2)=floor(fitting(2));
0291             warning([<span class="string">'lambda has been changed to '</span>,num2str(fitting(2)),<span class="string">'!'</span>]);
0292         <span class="keyword">end</span>
0293         <span class="keyword">if</span> fitting(2)&gt;size(data,2)
0294             fitting(2)=size(data,2);
0295             warning([<span class="string">'lambda has been changed to '</span>,num2str(fitting(2)),<span class="string">'!'</span>]);
0296         <span class="keyword">end</span>
0297 
0298     <span class="keyword">elseif</span> fitting(2)&gt;0
0299 
0300         <span class="keyword">if</span> fitting(2)&lt;=0.5
0301             warning(<span class="string">'lambda small. Troubles might occur!'</span>);
0302         <span class="keyword">end</span>
0303 
0304         fitting(2)=round(fitting(2)*size(data,2));
0305 
0306     <span class="keyword">elseif</span> fitting(2)&lt;=0
0307         fitting(2)=round(0.95*size(data,2));
0308         warning([<span class="string">'lambda has been changed to '</span>,num2str(fitting(2)),<span class="string">'!'</span>]);
0309     <span class="keyword">end</span>
0310 
0311 <span class="keyword">else</span>
0312     fitting=2;
0313     warning(<span class="string">'fitting has been changed to 2'</span>);
0314 <span class="keyword">end</span>
0315 
0316 <span class="keyword">if</span> isempty(init_flag)
0317     init_flag=1;
0318 <span class="keyword">elseif</span> not(init_flag==0 | init_flag==1)
0319     init_flag=1;
0320     warning(<span class="string">'init_flag has been changed to 1'</span>);
0321 <span class="keyword">end</span>
0322 
0323 <span class="keyword">if</span> (size(refpnt,2)&gt;size(refpnt,1))
0324     refpnt=refpnt';
0325 <span class="keyword">end</span>
0326 <span class="keyword">if</span> (size(refpnt,1)~=size(DATA,1))
0327     <span class="keyword">if</span> not(isempty(refpnt))
0328         refpnt=[];
0329         warning(<span class="string">'Dimension of refpnt dismatch. refpnt is put to [] (empty matrix).'</span>);
0330     <span class="keyword">end</span>
0331 <span class="keyword">end</span>
0332 <span class="keyword">if</span> (size(refpnt,2)&gt;1)
0333     refpnt=refpnt(:,1);
0334     warning(<span class="string">'Only the first point in refpnt is used.'</span>);
0335 <span class="keyword">end</span>
0336 
0337 <span class="comment">% Start the ICP algorithm</span>
0338 
0339 N = size(DATA,2);
0340 
0341 <a href="#_sub1" class="code" title="subfunction icp_init(init_flag,fitting)">icp_init</a>(init_flag,fitting);                    <span class="comment">% initiate a starting rotation matrix and starting translation vector</span>
0342 
0343 tes_flag=<a href="#_sub2" class="code" title="subfunction tes_flag=icp_struct(tes_flag)">icp_struct</a>(tes_flag);                  <span class="comment">% construct a Delaunay tesselation and two vectors make it easy to find in Tes</span>
0344 
0345 ERROR=<a href="#_sub3" class="code" title="subfunction ERROR=icp_closest_start(tes_flag,fitting)">icp_closest_start</a>(tes_flag,fitting);      <span class="comment">% initiate a vector with indices of closest MODEL points</span>
0346 
0347 <a href="#_sub5" class="code" title="subfunction ind=icp_transformation(fitting,refpnt) ">icp_transformation</a>(fitting,[]);                 <span class="comment">% find transformation</span>
0348 
0349 DATA = TR*data;                                 <span class="comment">% apply transformation</span>
0350 DATA=DATA+repmat(TT,1,N);                       <span class="comment">%</span>
0351 
0352 <span class="keyword">for</span> iter=1:max_iter
0353     olderror = ERROR;
0354     ERROR=<a href="#_sub4" class="code" title="subfunction ERROR=icp_closest(tes_flag,fitting)">icp_closest</a>(tes_flag,fitting);        <span class="comment">% find indices of closest MODEL points and total error</span>
0355 
0356     <span class="keyword">if</span> iter&lt;min_iter
0357         indexUsed=<a href="#_sub5" class="code" title="subfunction ind=icp_transformation(fitting,refpnt) ">icp_transformation</a>(fitting,[]);         <span class="comment">% find transformation</span>
0358     <span class="keyword">else</span>
0359         indexUsed=<a href="#_sub5" class="code" title="subfunction ind=icp_transformation(fitting,refpnt) ">icp_transformation</a>(fitting,refpnt);     <span class="comment">% find transformation</span>
0360     <span class="keyword">end</span>
0361 
0362     DATA = TR*data;                             <span class="comment">% apply transformation</span>
0363     DATA=DATA+repmat(TT,1,N);                   <span class="comment">%</span>
0364 
0365     <span class="keyword">if</span> iter&gt;=min_iter
0366         <span class="keyword">if</span> abs(olderror-ERROR) &lt; thres
0367             <span class="keyword">break</span>
0368         <span class="keyword">end</span>
0369     <span class="keyword">end</span>
0370 <span class="keyword">end</span>
0371 
0372 <span class="comment">%added by andrei</span>
0373 distance = 0;  
0374 <span class="keyword">for</span> i=1:N
0375             distance(i)=norm(MODEL(:,iclosest(i))-DATA(:,i));
0376 <span class="keyword">end</span>
0377 
0378 ERROR=0;
0379 ERROR=sum(distance(indexUsed));
0380 
0381 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0382 
0383 <a name="_sub1" href="#_subfunctions" class="code">function icp_init(init_flag,fitting)</a>
0384 <span class="comment">%function icp_init(init_flag)</span>
0385 <span class="comment">%ICP_INIT Initial alignment for ICP.</span>
0386 
0387 <span class="keyword">global</span> MODEL DATA TR TT
0388 
0389 <span class="keyword">if</span> init_flag==0
0390 
0391     TR=eye(size(MODEL,1));
0392     TT=zeros(size(MODEL,1),1);
0393 
0394 <span class="keyword">elseif</span> init_flag==1
0395 
0396     N = size(DATA,2);
0397 
0398     <span class="keyword">if</span> fitting(1)==2
0399 
0400         <span class="keyword">if</span> length(fitting)==1
0401            <span class="comment">% mem=mean(MODEL,2); med=mean(DATA,2); %comented by andrei</span>
0402             mem=median(MODEL,2); med=median(DATA,2); <span class="comment">% added by andrei</span>
0403         <span class="keyword">else</span>
0404             mem=MODEL*fitting(2:(N+1)); med=DATA*fitting(2:(N+1));
0405         <span class="keyword">end</span>
0406 
0407     <span class="keyword">else</span>
0408        <span class="comment">% mem=mean(MODEL,2); med=mean(DATA,2); %comented by andrei</span>
0409         mem=median(MODEL,2); med=median(DATA,2); <span class="comment">% added by andrei</span>
0410     <span class="keyword">end</span>
0411 
0412     TR=eye(size(MODEL,1));
0413     TT=mem-med;
0414     DATA=DATA+repmat(TT,1,N);                         <span class="comment">% apply transformation</span>
0415 
0416 <span class="keyword">else</span>
0417     error(<span class="string">'Wrong init_flag'</span>);
0418 <span class="keyword">end</span>
0419 
0420 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0421 
0422 <a name="_sub2" href="#_subfunctions" class="code">function tes_flag=icp_struct(tes_flag)</a>
0423 
0424 <span class="keyword">if</span> tes_flag==0
0425     <span class="keyword">global</span> ir
0426     <span class="keyword">if</span> isempty(ir)
0427         <span class="keyword">global</span> Tesind
0428         <span class="keyword">if</span> isempty(Tesind)
0429             error(<span class="string">'No tesselation system exists'</span>);
0430         <span class="keyword">else</span>
0431             tes_flag=2;
0432         <span class="keyword">end</span>
0433     <span class="keyword">else</span>
0434         tes_flag=1;
0435     <span class="keyword">end</span>
0436 <span class="keyword">elseif</span> tes_flag==3
0437     <span class="keyword">return</span>
0438 <span class="keyword">else</span>
0439     <span class="keyword">global</span> MODEL Tes
0440 
0441     [m,n]=size(MODEL);
0442 
0443     <span class="keyword">if</span> m==1
0444         [so1,ind1]=sort(MODEL);
0445         Tes=zeros(n,2);
0446         Tes(1:(n-1),1)=ind1(2:n)';
0447         Tes(2:n,2)=ind1(1:(n-1))';
0448         Tes(1,2)=Tes(1,1);
0449         Tes(n,1)=Tes(n,2);
0450         Tes(ind1,:)=Tes(:,:);
0451     <span class="keyword">else</span>
0452         Tes=delaunayn(MODEL');
0453 
0454         <span class="keyword">if</span> isempty(Tes)
0455 
0456             mem=mean(MODEL,2);
0457             MODELm=MODEL-repmat(mem,1,n);
0458             [U,S,V]=svd(MODELm*MODELm');
0459             onbasT=U(:,diag(S)&gt;1e-8)'
0460             MODELred=onbasT*MODEL;
0461 
0462             <span class="keyword">if</span> size(MODELred,1)==1
0463                 [so1,ind1]=sort(MODELred);
0464                 Tes=zeros(n,2);
0465                 Tes(1:(n-1),1)=ind1(2:n)';
0466                 Tes(2:n,2)=ind1(1:(n-1))';
0467                 Tes(1,2)=Tes(1,1);
0468                 Tes(n,1)=Tes(n,2);
0469                 Tes(ind1,:)=Tes(:,:);
0470             <span class="keyword">else</span>
0471                 Tes=delaunayn(MODELred');
0472             <span class="keyword">end</span>
0473         <span class="keyword">end</span>
0474     <span class="keyword">end</span>
0475     Tes=sortrows(sort(Tes,2));
0476     [mT,nT]=size(Tes);
0477 
0478     <span class="keyword">if</span> tes_flag==1
0479         <span class="keyword">global</span> ir jc
0480 
0481         num=zeros(1,n);
0482 
0483         <span class="keyword">for</span> i=1:mT
0484             <span class="keyword">for</span> j=1:nT
0485                 num(Tes(i,j))=num(Tes(i,j))+1;
0486             <span class="keyword">end</span>
0487         <span class="keyword">end</span>
0488 
0489         num=cumsum(num);
0490 
0491         jc=ones(1,n+1);
0492         jc(2:end)=num+jc(2:end);
0493 
0494         ir=zeros(1,num(end));
0495         ind=jc(1:(end-1));
0496 
0497         <span class="comment">%% calculate ir;</span>
0498         <span class="keyword">for</span> i=1:mT
0499             <span class="keyword">for</span> j=1:nT
0500                 ir(ind(Tes(i,j)))=i;
0501                 ind(Tes(i,j))=ind(Tes(i,j))+1;
0502             <span class="keyword">end</span>
0503         <span class="keyword">end</span>
0504     <span class="keyword">else</span>    <span class="comment">% tes_flag==2</span>
0505         <span class="keyword">global</span> Tesind Tesver
0506 
0507         Tesind=zeros(mT,nT);
0508         Tesver=zeros(mT,nT);
0509 
0510         couvec=zeros(mT,1);
0511 
0512         <span class="keyword">for</span> i=1:(mT-1)
0513             <span class="keyword">for</span> j=(i+1):mT
0514 
0515                 <span class="keyword">if</span> couvec(i)==nT
0516                     <span class="keyword">break</span>;
0517                 <span class="keyword">elseif</span> Tes(i,1)==Tes(j,1)
0518 
0519                     <span class="keyword">if</span> nT==2
0520 
0521                         Tesind(i,2)=j;
0522                         Tesind(j,2)=i;
0523 
0524                         Tesver(i,2)=2;
0525                         Tesver(j,2)=2;
0526 
0527                         couvec(i)=couvec(i)+1;
0528                         couvec(j)=couvec(j)+1;
0529 
0530                     <span class="keyword">else</span>
0531 
0532                         <span class="keyword">for</span> k=2:nT
0533                             <span class="keyword">for</span> kk=k:nT
0534                                 <span class="keyword">if</span> all(Tes(i,[2:(k-1),(k+1):nT])==Tes(j,[2:(kk-1),(kk+1):nT]))
0535                                     Tesind(i,k)=j;
0536                                     Tesind(j,kk)=i;
0537 
0538                                     Tesver(i,k)=kk;
0539                                     Tesver(j,kk)=k;
0540 
0541                                     couvec(i)=couvec(i)+1;
0542                                     couvec(j)=couvec(j)+1;
0543                                 <span class="keyword">end</span>
0544                             <span class="keyword">end</span>
0545 
0546                             <span class="keyword">if</span> or(couvec(i)==nT,couvec(j)==nT)
0547                                 <span class="keyword">break</span>
0548                             <span class="keyword">end</span>
0549                         <span class="keyword">end</span>
0550 
0551                     <span class="keyword">end</span>
0552 
0553                 <span class="keyword">elseif</span> Tes(i,1)==Tes(j,2)
0554 
0555                     <span class="keyword">if</span> nT==2
0556 
0557                         Tesind(i,2)=j;
0558                         Tesind(j,1)=i;
0559 
0560                         Tesver(i,2)=1;
0561                         Tesver(j,1)=2;
0562 
0563                         couvec(i)=couvec(i)+1;
0564                         couvec(j)=couvec(j)+1;
0565 
0566                     <span class="keyword">else</span>
0567                         <span class="keyword">for</span> k=2:nT
0568 
0569                             <span class="keyword">if</span> all(Tes(i,[2:(k-1),(k+1):nT])==Tes(j,3:nT))
0570                                 Tesind(i,k)=j;
0571                                 Tesind(j,1)=i;
0572 
0573                                 Tesver(i,k)=1;
0574                                 Tesver(j,1)=k;
0575 
0576                                 couvec(i)=couvec(i)+1;
0577                                 couvec(j)=couvec(j)+1;
0578                             <span class="keyword">end</span>
0579 
0580                             <span class="keyword">if</span> or(couvec(i)==nT,couvec(j)==nT)
0581                                 <span class="keyword">break</span>
0582                             <span class="keyword">end</span>
0583                         <span class="keyword">end</span>
0584                     <span class="keyword">end</span>
0585 
0586                 <span class="keyword">elseif</span> Tes(i,2)==Tes(j,1)
0587 
0588                     <span class="keyword">if</span> nT==2
0589 
0590                         Tesind(i,1)=j;
0591                         Tesind(j,2)=i;
0592                         Tesver(i,1)=2;
0593                         Tesver(j,2)=1;
0594 
0595                         couvec(i)=couvec(i)+1;
0596                         couvec(j)=couvec(j)+1;
0597 
0598                     <span class="keyword">else</span>
0599 
0600                         <span class="keyword">for</span> k=2:nT
0601 
0602                             <span class="keyword">if</span> all(Tes(i,3:nT)==Tes(j,[2:(k-1),(k+1):nT]))
0603                                 Tesind(i,1)=j;
0604                                 Tesind(j,k)=i;
0605                                 Tesver(i,1)=k;
0606                                 Tesver(j,k)=1;
0607 
0608                                 couvec(i)=couvec(i)+1;
0609                                 couvec(j)=couvec(j)+1;
0610                             <span class="keyword">end</span>
0611 
0612                             <span class="keyword">if</span> or(couvec(i)==nT,couvec(j)==nT)
0613                                 <span class="keyword">break</span>
0614                             <span class="keyword">end</span>
0615 
0616                         <span class="keyword">end</span>
0617 
0618                     <span class="keyword">end</span>
0619 
0620                 <span class="keyword">elseif</span> Tes(i,2)==Tes(j,2)
0621 
0622                     <span class="keyword">if</span> nT==2
0623 
0624                         Tesind(i,1)=j;
0625                         Tesind(j,1)=i;
0626 
0627                         Tesver(i,1)=1;
0628                         Tesver(j,1)=1;
0629 
0630                         couvec(i)=couvec(i)+1;
0631                         couvec(j)=couvec(j)+1;
0632 
0633                         <span class="keyword">if</span> Tes(j,1)&gt;Tes(i,2)
0634                             <span class="keyword">break</span>;
0635                         <span class="keyword">end</span>
0636 
0637                     <span class="keyword">elseif</span> all(Tes(i,3:end)==Tes(j,3:end))
0638 
0639                         Tesind(i,1)=j;
0640                         Tesind(j,1)=i;
0641 
0642                         Tesver(i,1)=1;
0643                         Tesver(j,1)=1;
0644 
0645                         couvec(i)=couvec(i)+1;
0646                         couvec(j)=couvec(j)+1;
0647 
0648                     <span class="keyword">end</span>
0649 
0650                 <span class="keyword">elseif</span> Tes(j,1)&gt;Tes(i,2)
0651                     <span class="keyword">break</span>;
0652                 <span class="keyword">end</span>
0653             <span class="keyword">end</span>
0654         <span class="keyword">end</span>
0655     <span class="keyword">end</span>
0656 <span class="keyword">end</span>
0657 
0658 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0659 
0660 <a name="_sub3" href="#_subfunctions" class="code">function ERROR=icp_closest_start(tes_flag,fitting)</a>
0661 <span class="comment">% Usage:</span>
0662 <span class="comment">%           ERROR = icp_closest_start(tes_flag)</span>
0663 <span class="comment">%</span>
0664 <span class="comment">% ERROR=sum of all errors between points in MODEL and points in DATA.</span>
0665 <span class="comment">%</span>
0666 <span class="comment">% ICP_CLOSEST_START finds indexes of closest MODEL points for each point in DATA.</span>
0667 <span class="comment">% The _start version allocates memory for iclosest and finds the closest MODEL points</span>
0668 <span class="comment">% to the DATA points</span>
0669 
0670 <span class="keyword">if</span> tes_flag==3
0671 
0672     <span class="keyword">global</span> MODEL DATA iclosest distance
0673     md=size(DATA,2);
0674     mm=size(MODEL,2);
0675 
0676     iclosest=zeros(1,md);
0677     distance=zeros(1,md); <span class="comment">%added by andrei</span>
0678 
0679     ERROR=0;
0680 
0681     <span class="keyword">for</span> id=1:md
0682         dist=Inf;
0683         <span class="keyword">for</span> im=1:mm
0684             dista=norm(MODEL(:,im)-DATA(:,id));
0685             <span class="keyword">if</span> dista&lt;dist
0686                 iclosest(id)=im;
0687                 dist=dista;
0688                 distance(id)=dista; <span class="comment">%added by andrei</span>
0689             <span class="keyword">end</span>
0690         <span class="keyword">end</span>
0691         ERROR=ERROR+<a href="#_sub6" class="code" title="subfunction ERR=err(dist,fitting,ind)">err</a>(dist,fitting,id);
0692     <span class="keyword">end</span>
0693 
0694 <span class="keyword">elseif</span> tes_flag==1
0695 
0696     <span class="keyword">global</span> MODEL DATA Tes ir jc iclosest distance
0697 
0698     md=size(DATA,2);
0699     iclosest=zeros(1,md);
0700     distance=zeros(1,md); <span class="comment">%added by andrei</span>
0701     mid=round(md/2);
0702 
0703     iclosest(mid)=round(size(MODEL,2)/2);
0704 
0705     bol=logical(1);
0706     <span class="keyword">while</span> bol
0707         bol=not(bol);
0708         distc=norm(DATA(:,mid)-MODEL(:,iclosest(mid)));
0709         distcc=2*distc;
0710         <span class="keyword">for</span> in=ir(jc(iclosest(mid)):(jc(iclosest(mid)+1)-1))
0711             <span class="keyword">for</span> ind=Tes(in,:)
0712                 distcc=norm(DATA(:,mid)-MODEL(:,ind));
0713                 <span class="keyword">if</span> distcc&lt;distc
0714                     distc=distcc;
0715                     bol=not(bol);
0716                     iclosest(mid)=ind;
0717                     distance(mid)=distcc; <span class="comment">%added by andrei</span>
0718                     <span class="keyword">break</span>;
0719                 <span class="keyword">end</span>
0720             <span class="keyword">end</span>
0721             <span class="keyword">if</span> bol
0722                 <span class="keyword">break</span>;
0723             <span class="keyword">end</span>
0724         <span class="keyword">end</span>
0725     <span class="keyword">end</span>
0726 
0727     ERROR=<a href="#_sub6" class="code" title="subfunction ERR=err(dist,fitting,ind)">err</a>(distc,fitting,mid);
0728 
0729     <span class="keyword">for</span> id = (mid+1):md
0730         iclosest(id)=iclosest(id-1);
0731        distance(id)=distance(id-1); <span class="comment">%added by andrei</span>
0732         bol=not(bol);
0733         <span class="keyword">while</span> bol
0734             bol=not(bol);
0735             distc=norm(DATA(:,id)-MODEL(:,iclosest(id)));
0736             distcc=2*distc;
0737             <span class="keyword">for</span> in=ir(jc(iclosest(id)):(jc(iclosest(id)+1)-1))
0738                 <span class="keyword">for</span> ind=Tes(in,:)
0739                     distcc=norm(DATA(:,id)-MODEL(:,ind));
0740                     <span class="keyword">if</span> distcc&lt;distc
0741                         distc=distcc;
0742                         bol=not(bol);
0743                         iclosest(id)=ind;
0744                         distance(id)=distcc; <span class="comment">%added by andrei</span>
0745                         <span class="keyword">break</span>;
0746                     <span class="keyword">end</span>
0747                 <span class="keyword">end</span>
0748                 <span class="keyword">if</span> bol
0749                     <span class="keyword">break</span>;
0750                 <span class="keyword">end</span>
0751             <span class="keyword">end</span>
0752         <span class="keyword">end</span>
0753         ERROR=ERROR+<a href="#_sub6" class="code" title="subfunction ERR=err(dist,fitting,ind)">err</a>(distc,fitting,id);
0754     <span class="keyword">end</span>
0755 
0756     <span class="keyword">for</span> id=(mid-1):-1:1
0757         iclosest(id)=iclosest(id+1);
0758         distance(id)=distance(id+1); <span class="comment">%added by andrei</span>
0759         bol=not(bol);
0760         <span class="keyword">while</span> bol
0761             bol=not(bol);
0762             distc=norm(DATA(:,id)-MODEL(:,iclosest(id)));
0763             distcc=2*distc;
0764             <span class="keyword">for</span> in=ir(jc(iclosest(id)):(jc(iclosest(id)+1)-1))
0765                 <span class="keyword">for</span> ind=Tes(in,:)
0766                     distcc=norm(DATA(:,id)-MODEL(:,ind));
0767                     <span class="keyword">if</span> distcc&lt;distc
0768                         distc=distcc;
0769                         bol=not(bol);
0770                         iclosest(id)=ind;
0771                         distance(id)=distcc; <span class="comment">%added by andrei</span>
0772                         <span class="keyword">break</span>;
0773                     <span class="keyword">end</span>
0774                 <span class="keyword">end</span>
0775                 <span class="keyword">if</span> bol
0776                     <span class="keyword">break</span>;
0777                 <span class="keyword">end</span>
0778             <span class="keyword">end</span>
0779         <span class="keyword">end</span>
0780         ERROR=ERROR+<a href="#_sub6" class="code" title="subfunction ERR=err(dist,fitting,ind)">err</a>(distc,fitting,id);
0781     <span class="keyword">end</span>
0782 <span class="keyword">else</span>  <span class="comment">% tes_flag==2</span>
0783 
0784     <span class="keyword">global</span> MODEL DATA Tes Tesind Tesver icTesind iclosest distance
0785 
0786     md=size(DATA,2);
0787     iclosest=zeros(1,md);
0788     distance=zeros(1,md); <span class="comment">%added by andrei</span>
0789     icTesind=zeros(1,md);
0790 
0791     [mTes,nTes]=size(Tes);
0792 
0793     mid=round(md*0.5);
0794 
0795     icTesind(mid)=round(mTes*0.5);
0796     iclosest(mid)=max(Tesind(icTesind(mid),:));
0797 
0798     visited=logical(zeros(1,mTes));
0799 
0800     visited(icTesind(mid))=1;
0801 
0802     di2vec=sqrt(sum((repmat(DATA(:,mid),1,nTes)-MODEL(:,Tes(icTesind(mid),:))).^2,1));
0803     bol=logical(1);
0804 
0805     <span class="keyword">while</span> bol
0806 
0807         [so,in]=sort(di2vec);
0808 
0809         <span class="keyword">for</span> ii=nTes:-1:2
0810             Ti=Tesind(icTesind(mid),in(ii));
0811             <span class="keyword">if</span> Ti&gt;0
0812                 <span class="keyword">if</span> not(visited(Ti))
0813                     <span class="keyword">break</span>;
0814                 <span class="keyword">end</span>
0815             <span class="keyword">end</span>
0816         <span class="keyword">end</span>
0817 
0818         <span class="keyword">if</span> Ti==0
0819             bol=not(bol);
0820         <span class="keyword">elseif</span> visited(Ti)
0821             bol=not(bol);
0822         <span class="keyword">else</span>
0823             Tv=Tesver(icTesind(mid),in(ii));
0824             visited(Ti)=1;
0825             icTesind(mid)=Ti;
0826             di2vec([1:(Tv-1),(Tv+1):nTes])=di2vec([1:(in(ii)-1),(in(ii)+1):nTes]);
0827             di2vec(Tv)=norm(DATA(:,mid)-MODEL(:,Tes(Ti,Tv)));
0828         <span class="keyword">end</span>
0829     <span class="keyword">end</span>
0830     iclosest(mid)=Tes(icTesind(mid),in(1));
0831     distance(mid)=so(1); <span class="comment">%added by andrei</span>
0832     ERROR=<a href="#_sub6" class="code" title="subfunction ERR=err(dist,fitting,ind)">err</a>(so(1),fitting,mid);
0833 
0834     <span class="keyword">for</span> id = (mid+1):md
0835 
0836         iclosest(id)=iclosest(id-1);
0837         icTesind(id)=icTesind(id-1);
0838 
0839         visited(:)=0;
0840         visited(icTesind(id))=1;
0841 
0842         di2vec=sqrt(sum((repmat(DATA(:,id),1,nTes)-MODEL(:,Tes(icTesind(id),:))).^2,1));
0843         bol=not(bol);
0844 
0845         <span class="keyword">while</span> bol
0846 
0847             [so,in]=sort(di2vec);
0848 
0849             <span class="keyword">for</span> ii=nTes:-1:2
0850                 Ti=Tesind(icTesind(id),in(ii));
0851                 <span class="keyword">if</span> Ti&gt;0
0852                     <span class="keyword">if</span> not(visited(Ti))
0853                         <span class="keyword">break</span>;
0854                     <span class="keyword">end</span>
0855                 <span class="keyword">end</span>
0856             <span class="keyword">end</span>
0857 
0858             <span class="keyword">if</span> Ti==0
0859                 bol=not(bol);
0860             <span class="keyword">elseif</span> visited(Ti)
0861                 bol=not(bol);
0862             <span class="keyword">else</span>
0863                 Tv=Tesver(icTesind(id),in(ii));
0864                 visited(Ti)=1;
0865                 icTesind(id)=Ti;
0866                 di2vec([1:(Tv-1),(Tv+1):nTes])=di2vec([1:(in(ii)-1),(in(ii)+1):nTes]);
0867                 di2vec(Tv)=norm(DATA(:,id)-MODEL(:,Tes(Ti,Tv)));
0868             <span class="keyword">end</span>
0869         <span class="keyword">end</span>
0870         iclosest(id)=Tes(icTesind(id),in(1));
0871         distance=so(1); <span class="comment">%added by andrei</span>
0872         ERROR=ERROR+<a href="#_sub6" class="code" title="subfunction ERR=err(dist,fitting,ind)">err</a>(so(1),fitting,id);
0873     <span class="keyword">end</span>
0874 
0875     <span class="keyword">for</span> id=(mid-1):-1:1
0876 
0877         iclosest(id)=iclosest(id+1);
0878         distance(id)=distance(id+1); <span class="comment">%added by andrei</span>
0879         icTesind(id)=icTesind(id+1);
0880 
0881         visited(:)=0;
0882         visited(icTesind(id))=1;
0883 
0884         di2vec=sqrt(sum((repmat(DATA(:,id),1,nTes)-MODEL(:,Tes(icTesind(id),:))).^2,1));
0885         bol=not(bol);
0886 
0887         <span class="keyword">while</span> bol
0888 
0889             [so,in]=sort(di2vec);
0890 
0891             <span class="keyword">for</span> ii=nTes:-1:2
0892                 Ti=Tesind(icTesind(id),in(ii));
0893                 <span class="keyword">if</span> Ti&gt;0
0894                     <span class="keyword">if</span> not(visited(Ti))
0895                         <span class="keyword">break</span>;
0896                     <span class="keyword">end</span>
0897                 <span class="keyword">end</span>
0898             <span class="keyword">end</span>
0899 
0900             <span class="keyword">if</span> Ti==0
0901                 bol=not(bol);
0902             <span class="keyword">elseif</span> visited(Ti)
0903                 bol=not(bol);
0904             <span class="keyword">else</span>
0905                 Tv=Tesver(icTesind(id),in(ii));
0906                 visited(Ti)=1;
0907                 icTesind(id)=Ti;
0908                 di2vec([1:(Tv-1),(Tv+1):nTes])=di2vec([1:(in(ii)-1),(in(ii)+1):nTes]);
0909                 di2vec(Tv)=norm(DATA(:,id)-MODEL(:,Tes(Ti,Tv)));
0910             <span class="keyword">end</span>
0911         <span class="keyword">end</span>
0912         iclosest(id)=Tes(icTesind(id),in(1));
0913         distance=so(1); <span class="comment">%added by andrei</span>
0914         ERROR=ERROR+<a href="#_sub6" class="code" title="subfunction ERR=err(dist,fitting,ind)">err</a>(so(1),fitting,id);
0915     <span class="keyword">end</span>
0916 
0917 <span class="keyword">end</span>
0918 
0919 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0920 
0921 <a name="_sub4" href="#_subfunctions" class="code">function ERROR=icp_closest(tes_flag,fitting)</a>
0922 <span class="comment">% Usage:</span>
0923 <span class="comment">%           ERROR = icp_closest(tes_flag,fitting)</span>
0924 <span class="comment">%</span>
0925 <span class="comment">% ERROR=sum of all errors between points in model and points in data.</span>
0926 <span class="comment">%</span>
0927 <span class="comment">% ICP_CLOSEST finds indexes of closest model points for each point in data.</span>
0928 
0929 <span class="keyword">if</span> tes_flag==3
0930 
0931     <span class="keyword">global</span> MODEL DATA iclosest distance
0932     md=size(DATA,2);
0933     mm=size(MODEL,2);
0934 
0935     ERROR=0;
0936 
0937     <span class="keyword">for</span> id=1:md
0938         dist=Inf;
0939         <span class="keyword">for</span> im=1:mm
0940             dista=norm(MODEL(:,im)-DATA(:,id));
0941             <span class="keyword">if</span> dista&lt;dist
0942                 iclosest(id)=im;
0943                 dist=dista;
0944                 distance(id)=dista;<span class="comment">%added by andrei</span>
0945             <span class="keyword">end</span>
0946         <span class="keyword">end</span>
0947         ERROR=ERROR+<a href="#_sub6" class="code" title="subfunction ERR=err(dist,fitting,ind)">err</a>(dist,fitting,id);
0948     <span class="keyword">end</span>
0949 
0950 <span class="keyword">elseif</span> tes_flag==1
0951 
0952     <span class="keyword">global</span> MODEL DATA Tes ir jc iclosest distance
0953 
0954     [mTes,nTes]=size(Tes);
0955     ERROR=0;
0956     bol=logical(0);
0957 
0958     <span class="keyword">for</span> id=1:size(DATA,2)
0959 
0960         bol=not(bol);
0961         <span class="keyword">while</span> bol
0962             bol=not(bol);
0963             distc=norm(DATA(:,id)-MODEL(:,iclosest(id)));
0964             distcc=2*distc;
0965             <span class="keyword">for</span> in=ir(jc(iclosest(id)):(jc(iclosest(id)+1)-1))
0966                 <span class="keyword">for</span> ind=Tes(in,:)
0967                     distcc=norm(DATA(:,id)-MODEL(:,ind));
0968                     <span class="keyword">if</span> distcc&lt;distc
0969                         distc=distcc;
0970                         bol=not(bol);
0971                         iclosest(id)=ind;
0972                         distance(id)=distcc; <span class="comment">%added by andrei</span>
0973                         <span class="keyword">break</span>;
0974                     <span class="keyword">end</span>
0975                 <span class="keyword">end</span>
0976                 <span class="keyword">if</span> bol
0977                     <span class="keyword">break</span>;
0978                 <span class="keyword">end</span>
0979             <span class="keyword">end</span>
0980         <span class="keyword">end</span>
0981         ERROR=ERROR+<a href="#_sub6" class="code" title="subfunction ERR=err(dist,fitting,ind)">err</a>(distc,fitting,id);
0982     <span class="keyword">end</span>
0983 
0984 <span class="keyword">else</span>  <span class="comment">% tes_flag==2</span>
0985 
0986     <span class="keyword">global</span> MODEL DATA Tes Tesind Tesver iclosest icTesind distance
0987 
0988     [mTes,nTes]=size(Tes);
0989     ERROR=0;
0990     bol=logical(0);
0991     visited=logical(zeros(1,mTes));
0992 
0993     <span class="keyword">for</span> id=1:size(DATA,2)
0994         visited(:)=0;
0995         visited(icTesind(id))=1;
0996 
0997         di2vec=sqrt(sum((repmat(DATA(:,id),1,nTes)-MODEL(:,Tes(icTesind(id),:))).^2,1));
0998         bol=not(bol);
0999 
1000         <span class="keyword">while</span> bol
1001 
1002             [so,in]=sort(di2vec);
1003 
1004             <span class="keyword">for</span> ii=nTes:-1:2
1005                 Ti=Tesind(icTesind(id),in(ii));
1006                 <span class="keyword">if</span> Ti&gt;0
1007                     <span class="keyword">if</span> not(visited(Ti))
1008                         <span class="keyword">break</span>;
1009                     <span class="keyword">end</span>
1010                 <span class="keyword">end</span>
1011             <span class="keyword">end</span>
1012 
1013             <span class="keyword">if</span> Ti==0
1014                 bol=not(bol);
1015             <span class="keyword">elseif</span> visited(Ti)
1016                 bol=not(bol);
1017             <span class="keyword">else</span>
1018                 Tv=Tesver(icTesind(id),in(ii));
1019                 visited(Ti)=1;
1020                 icTesind(id)=Ti;
1021                 di2vec([1:(Tv-1),(Tv+1):nTes])=di2vec([1:(in(ii)-1),(in(ii)+1):nTes]);
1022                 di2vec(Tv)=norm(DATA(:,id)-MODEL(:,Tes(Ti,Tv)));
1023             <span class="keyword">end</span>
1024         <span class="keyword">end</span>
1025         iclosest(id)=Tes(icTesind(id),in(1));
1026         distance=so(1); <span class="comment">%added by andrei</span>
1027         ERROR=ERROR+<a href="#_sub6" class="code" title="subfunction ERR=err(dist,fitting,ind)">err</a>(so(1),fitting,id);
1028     <span class="keyword">end</span>
1029 <span class="keyword">end</span>
1030 
1031 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1032 
1033 <a name="_sub5" href="#_subfunctions" class="code">function ind=icp_transformation(fitting,refpnt) </a><span class="comment">% &quot;ind=&quot; added by andrei</span>
1034 <span class="comment">% Finds the rotation and translation of the DATA points</span>
1035 
1036 <span class="keyword">global</span> MODEL DATA iclosest TR TT distance
1037 
1038 M=size(DATA,1);
1039 N=size(DATA,2);
1040 
1041 bol=0;
1042 
1043 <span class="keyword">if</span> not(isempty(refpnt))
1044     bol=1;
1045     dis=sqrt(sum((MODEL(:,iclosest)-repmat(refpnt,1,N)).^2,1));
1046     weights=<a href="#_sub7" class="code" title="subfunction weights=weightfcn(distances)">weightfcn</a>(dis');
1047 <span class="keyword">end</span>
1048 
1049 <span class="keyword">if</span> bol
1050 
1051     <span class="keyword">if</span> fitting(1)==2
1052 
1053         <span class="keyword">if</span> length(fitting)&gt;1
1054             weights=fitting(2:(N+1)).*weights;
1055             weights=weights/sum(weights);
1056         <span class="keyword">end</span>
1057 
1058         med=DATA*weights; mem=MODEL(:,iclosest)*weights;
1059         A=DATA-repmat(med,1,N);
1060         B=MODEL(:,iclosest)-repmat(mem,1,N);
1061 
1062         <span class="keyword">for</span> i=1:N
1063             A(:,i)=weights(i)*A(:,i);
1064         <span class="keyword">end</span>
1065 
1066     <span class="keyword">elseif</span> fitting(1)==3
1067 
1068         V=sum((DATA-MODEL(:,iclosest)).^2,1);
1069         [soV,in]=sort(V);
1070         ind=in(1:fitting(2));
1071 
1072         weights(ind)=weights(ind)/sum(weights(ind));
1073 
1074         med=DATA(:,ind)*weights(ind); mem=MODEL(:,iclosest(ind))*weights(ind);
1075         A=DATA(:,ind)-repmat(med,1,fitting(2));
1076         B=MODEL(:,iclosest(ind))-repmat(mem,1,fitting(2));
1077 
1078         <span class="keyword">for</span> i=1:fitting(2)
1079             A(:,i)=weights(ind(i))*A(:,ind(i));
1080         <span class="keyword">end</span>
1081 
1082     <span class="keyword">end</span>
1083 
1084 <span class="keyword">else</span>
1085 
1086     <span class="keyword">if</span> fitting(1)==2
1087 
1088         <span class="keyword">if</span> length(fitting)==1
1089 
1090             med=mean(DATA,2); mem=mean(MODEL(:,iclosest),2);
1091             A=DATA-repmat(med,1,N);
1092             B=MODEL(:,iclosest)-repmat(mem,1,N);
1093 
1094         <span class="keyword">else</span>
1095 
1096             med=DATA*fitting(2:(N+1)); mem=MODEL(:,iclosest)*fitting(2:(N+1));
1097             A=DATA-repmat(med,1,N);
1098             B=MODEL(:,iclosest)-repmat(mem,1,N);
1099 
1100             <span class="keyword">for</span> i=1:N
1101                 A(:,i)=fitting(i+1)*A(:,i);
1102             <span class="keyword">end</span>
1103 
1104         <span class="keyword">end</span>
1105 
1106     <span class="keyword">elseif</span> fitting(1)==3
1107 
1108         V=sum((DATA-MODEL(:,iclosest)).^2,1);
1109         [soV,in]=sort(V);
1110         ind=in(1:fitting(2));
1111         
1112         <span class="comment">%modified by andrei</span>
1113         <span class="comment">%figure; plot(V);</span>
1114         <span class="comment">% remove the repeted values in iclosest</span>
1115         
1116 <span class="comment">%             repetedVal=[];</span>
1117 <span class="comment">%             for i=1:length(ind)</span>
1118 <span class="comment">%                 for j=1:i-1</span>
1119 <span class="comment">%                     if iclosest(ind(i))==iclosest(ind(j))</span>
1120 <span class="comment">%                         repetedVal=[repetedVal i];</span>
1121 <span class="comment">%                     end</span>
1122 <span class="comment">%                 end</span>
1123 <span class="comment">%             end</span>
1124 <span class="comment">%             ind(repetedVal)=[];</span>
1125         
1126         <span class="comment">%remove the outliers from the clouds points</span>
1127         V2=V(ind);
1128         median_distance=median(V2);
1129         std_distance=std(V2);
1130         ind2=find(V2&lt;=(median_distance+1.5*std_distance));
1131         fitting(2)=length(ind2);
1132         ind=ind(ind2);
1133         <span class="comment">%andrei</span>
1134 
1135         <span class="comment">%med=mean(DATA(:,ind),2); mem=mean(MODEL(:,iclosest(ind)),2);</span>
1136         <span class="comment">%commented by andrei</span>
1137         med=mean(DATA(:,ind),2); mem=mean(MODEL(:,iclosest(ind)),2);
1138         A=DATA(:,ind)-repmat(med,1,fitting(2));
1139         B=MODEL(:,iclosest(ind))-repmat(mem,1,fitting(2));
1140 
1141     <span class="keyword">end</span>
1142 
1143 <span class="keyword">end</span>
1144 
1145 [U,S,V] = svd(B*A');
1146 U(:,end)=U(:,end)*det(U*V');
1147 R=U*V';
1148 
1149 <span class="comment">% Compute the translation</span>
1150 T=(mem-R*med);
1151 TR=R*TR;  TT=R*TT+T;
1152 
1153 <a name="_sub6" href="#_subfunctions" class="code">function ERR=err(dist,fitting,ind)</a>
1154 
1155 <span class="keyword">if</span> fitting(1)==2
1156     <span class="keyword">if</span> (ind+1)&gt;length(fitting)
1157         ERR=dist^2;
1158     <span class="keyword">else</span>
1159         ERR=fitting(ind+1)*dist^2;
1160     <span class="keyword">end</span>
1161 <span class="keyword">elseif</span> fitting(1)==3
1162     ERR=dist^2;<span class="comment">%commented by andrei</span>
1163     <span class="comment">%ERR=dist; %added by andrei</span>
1164 <span class="keyword">else</span>
1165     ERR=0;
1166     warning(<span class="string">'Unknown value of fitting!'</span>);
1167 <span class="keyword">end</span>
1168 
1169 <a name="_sub7" href="#_subfunctions" class="code">function weights=weightfcn(distances)</a>
1170 
1171 maxdistances=max(distances);
1172 mindistances=min(distances);
1173 
1174 <span class="keyword">if</span> maxdistances&gt;1.1*mindistances
1175     weights=1+mindistances/(maxdistances-mindistances)-distances/(maxdistances-mindistances);
1176 <span class="keyword">else</span>
1177     weights=maxdistances+mindistances-distances;
1178 <span class="keyword">end</span>
1179 
1180 weights=weights/sum(weights);</pre></div>
<hr><address>Generated on Wed 27-Oct-2010 20:01:59 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" target="_parent">m2html</a></strong> &copy; 2003</address>
</body>
</html>